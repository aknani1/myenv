Folder Structure
--------------------------------------------------
app/
    camera.py
    routes.py
    __init__.py
    statics/
        css/
            main.css
    templates/
        index.html
    __pycache__/
        camera.cpython-310.pyc
        camera.cpython-311.pyc
        camera.cpython-312.pyc
        camera.cpython-38.pyc
        init.cpython-38.pyc
        routes.cpython-310.pyc
        routes.cpython-311.pyc
        routes.cpython-312.pyc
        routes.cpython-38.pyc
        __init__.cpython-310.pyc
        __init__.cpython-311.pyc
        __init__.cpython-312.pyc
        __init__.cpython-313.pyc
        __init__.cpython-38.pyc


File Contents
--------------------------------------------------


C:\Users\aknani\myenv\app\camera.py
File type: .py
import pyrealsense2 as rs
import numpy as np
import cv2
import base64
from app import socketio

streaming = {"status": True}  # Mutable dictionary
framerate = {"status": 15}
exposure_value = {"status": 80}
metadata_toggles = {
    "rgb": False,
    "depth": False
}
config = rs.config()
config.enable_stream(rs.stream.color, 640, 360, rs.format.bgr8, framerate["status"])
config.enable_stream(rs.stream.depth, 640, 360, rs.format.z16, framerate["status"])


def generate_frames():
    global color_sensor
    streaming["status"] = True
    pipeline = rs.pipeline()
    config.enable_stream(rs.stream.color, 640, 360, rs.format.bgr8, framerate["status"])
    config.enable_stream(rs.stream.depth, 640, 360, rs.format.z16, framerate["status"])
    profile = pipeline.start(config)

    device = profile.get_device()
    sensors = device.query_sensors()

    for sensor in sensors:
        if sensor.get_info(rs.camera_info.name) == "RGB Camera":
            color_sensor = sensor
            break

    if color_sensor is None:
        raise RuntimeError("Color sensor not found!")

    # Step 4: Disable auto-exposure
    color_sensor.set_option(rs.option.enable_auto_exposure, 0)

    # Step 5: Set manual exposure (e.g., 1000 microseconds)
    #exposure_value = 1000  # Adjust this value as needed
    print(f"Manual exposure set to {exposure_value} microseconds.")


    try:
        while streaming["status"]:
            frames = pipeline.wait_for_frames()
            color_frame = frames.get_color_frame()
            depth_frame = frames.get_depth_frame()

            if not color_frame or not depth_frame or not streaming:
                continue
            color_image = np.asanyarray(color_frame.get_data())
            depth_colorized = rs.colorizer().colorize(depth_frame)
            depth_image = np.asanyarray(depth_colorized.get_data())
                        # Metadata
            hardware_fps = color_frame.get_frame_metadata(rs.frame_metadata_value.actual_fps)
            resolution_rgb = f"{color_image.shape[1]}x{color_image.shape[0]}"
            resolution_depth = f"{depth_image.shape[1]}x{depth_image.shape[0]}"
            if metadata_toggles["rgb"]:
                cv2.putText(color_image, f"FPS: {hardware_fps}", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
                cv2.putText(color_image, f"Resolution: {resolution_rgb}", (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
            if metadata_toggles["depth"]:
                cv2.putText(depth_image, f"FPS: {hardware_fps}", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 0), 2)
                cv2.putText(depth_image, f"Resolution: {resolution_depth}", (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 0), 2)
            _, color_buffer = cv2.imencode('.jpg', color_image)
            _, depth_buffer = cv2.imencode('.jpg', depth_image)
            color_frame_encoded = base64.b64encode(color_buffer).decode('utf-8')
            depth_frame_encoded = base64.b64encode(depth_buffer).decode('utf-8')

            yield {"color": color_frame_encoded, "depth": depth_frame_encoded}
        pipeline.stop()
        
    finally:
        pipeline.stop()

def change_exposure():
    color_sensor.set_option(rs.option.exposure, exposure_value["status"])

def stop_generating_frames():
    streaming["status"] = False


def toggle_metadata(module):
    if module in metadata_toggles:
        metadata_toggles[module] = not metadata_toggles[module]

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\routes.py
File type: .py
from flask import render_template, current_app,request,jsonify
from app import socketio
from .camera import generate_frames
from .camera import stop_generating_frames
import pyrealsense2 as rs
from .camera import streaming
from .camera import framerate
from .camera import exposure_value
from .camera import change_exposure
from .camera import toggle_metadata


pipeline = rs.pipeline()
config = rs.config()

def init_routes(app):
    @app.route('/')
    def index():
        return render_template('index.html')
    @app.route('/api/configure', methods=['POST'])
    def configure():
        try:
            # Parse the JSON payload from the client
            data = request.json
            module = data.get('module')
            resolution = data.get('resolution') 
            frame_rate = int(data.get('frame_rate'))
            stop_generating_frames()
            print(data)
            # Validate the input
            if not module or not resolution or not frame_rate:
                return jsonify({"error": "Invalid input"}), 400
    
            # Parse resolution into width and height
            width, height = map(int, resolution.split('x'))
    
            # Configure the RealSense pipeline based on the module
            if module == 'depth':
                rs.pipeline.stop()  # Stop the current pipeline
                config.enable_stream(rs.stream.depth, 640, 360, rs.format.z16, frame_rate)  # Apply new configuration
                pipeline.start(config)  # Restart the pipeline with updated config

                print(f"Depth Module updated to {resolution} at {frame_rate} FPS")
            elif module == 'rgb': 
                streaming["status"] = True
                framerate["status"] = frame_rate
                print(f"RGB Module updateddddddddd to {resolution} at {frame_rate} FPS")
            else:
                return jsonify({"error": "Invalid module"}), 400
    

            return jsonify({
                "message": f"{module.capitalize()} Module updated",
                "resolution": resolution,
                "frame_rate": frame_rate
            }), 200
    
        except Exception as e:
            print(f"Error: {e}")
            return jsonify({"error": str(e)}), 500

    @app.route('/api/toggle_metadata', methods=['POST'])
    def toggle_metadata_endpoint():
        data = request.json
        module = data.get('module')
        if module not in ['rgb', 'depth']:
            return jsonify({"error": "Invalid module"}), 400
        
        toggle_metadata(module)
        return jsonify({"message": f"{module.capitalize()} metadata toggled", "status": metadata_toggles[module]})

    @app.route('/api/exposure', methods=['POST'])
    def update_exposure():
        try:
            # Parse the JSON payload from the client
            data = request.json
            module = data.get('module')
            req_exposure_value = int(data.get('exposure'))  # Exposure value (e.g., 8500)
            
            print(data)
            # Validate input
            if not module or exposure_value is None:
                return jsonify({"error": "Invalid input"}), 400
    
            if module == 'depth':
                # Ensure depth sensor exists
                if len(sensors) < 1:
                    return jsonify({"error": "Depth sensor not found"}), 500
    
                depth_sensor = sensors[0]  # Assuming depth is the first sensor
                if rs.option.exposure in depth_sensor.get_supported_options():
                    depth_sensor.set_option(rs.option.exposure, exposure_value)
                    print(f"Depth Module exposure updated to {exposure_value}")
                else:
                    return jsonify({"error": "Exposure option not supported for Depth Module"}), 400
    
            elif module == 'rgb':
                # Ensure RGB sensor exists
                exposure_value["status"] = req_exposure_value
                change_exposure()
    
            else:
                return jsonify({"error": "Invalid module"}), 400
    
            return jsonify({
                "message": f"{module.capitalize()} Module exposure updated",
                "exposure": exposure_value
            }), 200
    
        except Exception as e:
            print(f"Error: {e}")
            return jsonify({"error": str(e)}), 500

    @socketio.on('connect')
    def handle_connect():
        
        print('Client connected')

    @socketio.on('start_stream')
    def start_stream():
        for frame in generate_frames():
            socketio.emit('video_frame', frame)





@socketio.on('update_configuration')
def update_configuration(data):
    module = data['module']   # 'depth' or 'rgb'
    resolution = data['resolution']   # e.g., '640x480'
    frame_rate = int(data['frameRate'])   # e.g., '30'

    width, height = map(int, resolution.split('x'))

    if module == 'depth':
        config.enable_stream(rs.stream.depth, width, height, rs.format.z16, frame_rate)
        print(f"Depth Module updated to {resolution} at {frame_rate} FPS")
    elif module == 'rgb':
        config.enable_stream(rs.stream.color, width, height, rs.format.bgr8, frame_rate)
        print(f"RGB Module updated to {resolution} at {frame_rate} FPS")

# Call this function in __init__.py after creating the app
# init_routes(current_app)

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\__init__.py
File type: .py
from flask import Flask
from flask_cors import CORS
from flask_socketio import SocketIO
import time

app = Flask(__name__)
CORS(app)
socketio = SocketIO(app, cors_allowed_origins="*")

def create_app():
    app.config.from_object('config.Config')

    socketio.init_app(app)

    with app.app_context():
        from app import routes
        from .routes import init_routes
        init_routes(app)

    return app


--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\statics\css\main.css
File type: .css
body {
    font-family: Arial, sans-serif;
    text-align: center;
}
h1 {
    color: #333;
}
#video-stream {
    max-width: 100%;
    height: auto;
}

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\templates\index.html
File type: .html
<!DOCTYPE html>
<html>
<head>
    <title>RealSense Camera Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <h1>RealSense Camera Viewer</h1>
    <img id="video-stream" src="">
    <script>
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('data', function(data) {
            document.getElementById('video-stream').src = 'data:image/jpeg;base64,' + data.image;
        });
    </script>
</body>
</html>

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\__pycache__\camera.cpython-38.pyc
File type: .pyc
U

    è Kg÷  ã                   @   s8   d dl Zd dlZd dlZd dlZd dlmZ dd„ ZdS )é    N)Úsocketioc                  C   sž   t  ¡ } t  ¡ }| t jjddt jjd¡ |  |¡ zZ|  
¡ }| ¡ }|sLq6t 
| ¡ ¡}t d|¡\}}t |¡ d¡}t dd|i¡ q6W 5 |  	¡  X d S )Ni€  ià  é   z.jpgzutf-8ÚframeÚimage)ÚrsÚpipelineÚconfigZ
enable_streamÚstreamÚcolorÚformatZbgr8ÚstartÚstopZwait_for_framesZget_color_frameÚnpZ
asanyarrayÚget_dataÚcv2ZimencodeÚbase64Ú	b64encodeÚdecoder   Úemit)r   r   ÚframesZcolor_frameZcolor_imageÚretÚbufferr   © r   ú\C:\Users\mayyas\Documents\technion\semester_5\IntelRealSenseProject\WEB_VIEWER\app\camera.pyÚget_realsense_frame   s    
r   )	Zpyrealsense2r   Znumpyr   r   r   Úappr   r   r   r   r   r   Ú<module>   s
   

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\__pycache__\init.cpython-38.pyc
File type: .pyc
U

    ]Kg  ã                   @   s*   d dl mZ d dlmZ eƒ Zdd„ ZdS )é    )ÚFlask)ÚSocketIOc                  C   s.   t tƒ} | j d¡ t | ¡ ddlm} | S )Nz
config.Configr   )Úroutes)r   Ú__name__ZconfigZfrom_objectÚsocketioZinit_appÚappr   )r   r   © r   úZC:\Users\mayyas\Documents\technion\semester_5\IntelRealSenseProject\WEB_VIEWER\app\init.pyÚ
create_app   s
    
r
   N)Zflaskr   Zflask_socketior   r   r
   r   r   r   r	   Ú<module>   s   

--------------------------------------------------
File End
--------------------------------------------------


C:\Users\aknani\myenv\app\__pycache__\routes.cpython-38.pyc
File type: .pyc
U

    Ú&Kg°  ã                   @   s4   d dl mZmZ d dlmZ ddlmZ dd„ ZdS )é    )Úrender_templateÚcurrent_app)Úsocketioé   )Úget_realsense_framec                 C   s(   |   d¡dd„ ƒ}t d¡dd„ ƒ}d S )Nú/c                   S   s   t dƒS )Nz
index.html)r   © r   r   ú\C:\Users\mayyas\Documents\technion\semester_5\IntelRealSenseProject\WEB_VIEWER\app\routes.pyÚindex   s    zinit_routes.<locals>.indexÚconnectc                   S   s   t  t¡ d S )N)r   Ústart_background_taskr   r   r   r   r	   Úhandle_connect
   s    z#init_routes.<locals>.handle_connect)Úrouter   Úon)Úappr
   r
   r   r   r	   Úinit_routes   s    
r   N)Úflaskr   r   r   r   Zcamerar   r   r   r   r   r	   Ú<module>   s   

--------------------------------------------------
File End
--------------------------------------------------
